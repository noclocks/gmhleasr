---
title: "Entrata API Integration with gmhleasr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Entrata API Integration with gmhleasr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE,
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)
```

```{r setup}
library(gmhleasr)
```

<img src='./assets/entrata/entrata-logo-light.png' align='right' width='150' height='auto' alt='entrata logo'/>

## Contents

- [Overview](#overview)
- [Authentication and Configuration](#authentication-and-configuration)
- [Basic Usage](#basic-usage)
- [Endpoints and Methods](#endpoints-and-methods)
- [Error Handling and Logging](#error-handling-and-logging)
- [Caching](#caching)
- [Rate Limiting and Throttling](#rate-limiting-and-throttling)
- [Advanced Usage](#advanced-usage)

## Overview

The `gmhleasr` package provides a robust interface for interacting with the Entrata API. This vignette will guide you through the process of setting up the API configuration, making requests, and handling responses using the package's functions.

## Authentication and Configuration

To use the Entrata API, you need to set up your authentication credentials. The `gmhleasr` package uses a configuration file to manage these credentials. Here's how to set it up:

### Using config.yml (Recommended)

1. Create a `config.yml` file in your project directory with the following structure:

```yaml
default:
  entrata:
    username: "your_username"
    password: "your_password"
    base_url: "https://your-subdomain.entrata.com"
    user_agent: "your_user_agent"  # Optional
    rate_limit: 100  # Optional
    cache_dir: "path/to/cache"  # Optional
    cache_ttl: 3600  # Optional, in seconds
```

2. Use the `create_entrata_config()` function to load this configuration:

```{r}
config <- create_entrata_config()
```

This function will automatically read the configuration from your `config.yml` file if it exists in the current working directory.

### Manual Configuration

If you prefer not to use a config.yml file, you can manually create the configuration:

```{r}
config <- create_entrata_config(
  username = "your_username",
  password = "your_password",
  base_url = "https://your-subdomain.entrata.com",
  user_agent = "your_user_agent",  # Optional
  rate_limit = 100,  # Optional
  cache_dir = "path/to/cache",  # Optional
  cache_ttl = 3600  # Optional, in seconds
)
```

### Configuration Options

- `username`: Your Entrata API username (required)
- `password`: Your Entrata API password (required)
- `base_url`: The base URL for API requests (required)
- `user_agent`: A custom user agent string for API requests (optional)
- `rate_limit`: The rate limit for API requests (optional)
- `cache_dir`: Directory for caching API responses (optional)
- `cache_ttl`: Time-to-live for cached responses in seconds (optional, default is 3600)

### Saving and Loading Configurations

You can save your configuration to a file:

```{r}
save_config(config, "my_config.yml")
```

And load it later:

```{r}
config <- create_entrata_config(config_path = "my_config.yml")
```

## Basic Usage

Once you have your configuration set up, you can start making requests to the Entrata API. Here are some basic examples:

### Retrieving Properties

To get a list of properties:

```{r}
properties <- entrata_properties(config = config)
print(properties)
```

### Retrieving Leases

To get lease information for a specific property:

```{r}
leases <- entrata_leases(property_id = "12345", config = config)
print(leases)
```

### Getting Available Reports

To get a list of available reports:

```{r}
reports <- get_entrata_reports_list(config = config)
print(reports)
```

## Endpoints and Methods

The Entrata API has several endpoints, each with specific methods. The `gmhleasr` package provides wrapper functions for common endpoints, but you can also use the general `entrata()` function for any endpoint:

```{r}
custom_request <- entrata(
  endpoint = "custom_endpoint",
  method = "customMethod",
  method_params = list(param1 = "value1", param2 = "value2"),
  config = config
)
```

## Error Handling and Logging

The `gmhleasr` package includes robust error handling and logging. If an API request fails, an informative error message will be thrown, and the error will be logged using the `futile.logger` package.

To view more detailed logs, you can set the log level:

```{r}
futile.logger::flog.threshold(futile.logger::DEBUG)
```

## Caching

To improve performance and reduce API calls, the `gmhleasr` package includes caching functionality. By default, caching is enabled for all API requests if a `cache_dir` is specified in the configuration. You can disable caching for a specific request like this:

```{r}
properties <- entrata_properties(config = config, cache = FALSE)
```

## Rate Limiting and Throttling

The Entrata API has rate limits in place to prevent overuse. The `gmhleasr` package automatically handles rate limiting by implementing a backoff strategy when limits are reached.

## Advanced Usage

For more complex use cases, you can use the `entrata()` function directly. This function gives you full control over the API request:

```{r}
response <- entrata(
  endpoint = "reports",
  method = "getReportData",
  method_version = "r3",
  method_params = list(
    reportName = "custom_report",
    filters = list(
      startDate = "2023-01-01",
      endDate = "2023-12-31"
    )
  ),
  config = config,
  perform = TRUE,
  extract = TRUE
)
```

This example shows how to request a custom report with specific parameters.

Remember to always handle API responses carefully, as they may contain sensitive information. The `gmhleasr` package provides tools to help you process and analyze the data safely and efficiently.

For more detailed information about specific endpoints and methods, please refer to the official Entrata API documentation.
